// ===== ÊöóË®ò„Ç´„Éº„Éâ„Ç∑„Çπ„ÉÜ„É†ÔºàAnki„Çπ„Çø„Ç§„É´Ôºâ =====
const FlashCardModule = {
    cards: [],
    currentCard: 0,
    session: {
        correct: 0,
        wrong: 0,
        total: 0,
        startTime: null,
        isActive: false
    },
    
    // SM-2„Ç¢„É´„Ç¥„É™„Ç∫„É†Ë®≠ÂÆö
    SM2_CONFIG: {
        INITIAL_INTERVAL: 1,
        INITIAL_EASE_FACTOR: 2.5,
        MIN_EASE_FACTOR: 1.3,
        QUALITY_THRESHOLD: 3,
        EASE_ADJUSTMENT: [
            -0.8, -0.54, -0.32, -0.14, 0, 0.15 // quality 0-5„Å´ÂØæÂøú
        ]
    },
    
    // ÂàùÊúüÂåñ
    init() {
        this.loadCards();
        this.setupEventListeners();
        console.log('üé¥ ÊöóË®ò„Ç´„Éº„Éâ„É¢„Ç∏„É•„Éº„É´ÂàùÊúüÂåñÂÆå‰∫Ü');
    },
    
    // „Ç´„Éº„ÉâË™≠„ÅøËæº„Åø
    loadCards() {
        this.cards = Utils.safeLocalStorage.get('flashCards', []);
        console.log(`üé¥ ${this.cards.length}Êûö„ÅÆ„Ç´„Éº„Éâ„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
    },
    
    // „Ç´„Éº„Éâ‰øùÂ≠ò
    saveCards() {
        Utils.safeLocalStorage.set('flashCards', this.cards);
    },
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    setupEventListeners() {
        document.addEventListener('keydown', (e) => {
            if (this.session.isActive) {
                this.handleKeyboardInput(e);
            }
        });
    },
    
    // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•ÂäõÂá¶ÁêÜ
    handleKeyboardInput(e) {
        switch(e.key) {
            case ' ': // „Çπ„Éö„Éº„Çπ„Ç≠„Éº„Åß„Ç´„Éº„Éâ„Çí„ÇÅ„Åè„Çã
                e.preventDefault();
                this.flipCard();
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                this.rateCard(parseInt(e.key));
                break;
            case 'Escape':
                this.endSession();
                break;
        }
    },
    
    // „Ç´„Éº„Éâ‰ΩúÊàê
    createCard(front, back, tags = [], subject = '') {
        const card = {
            id: Utils.generateId(),
            front: front.trim(),
            back: back.trim(),
            tags: Array.isArray(tags) ? tags : [],
            subject: subject,
            created: new Date().toISOString(),
            lastReviewed: null,
            nextReview: new Date().toISOString(),
            interval: this.SM2_CONFIG.INITIAL_INTERVAL,
            easeFactor: this.SM2_CONFIG.INITIAL_EASE_FACTOR,
            repetitions: 0,
            reviews: [],
            isLearning: true,
            lapses: 0
        };
        
        this.cards.push(card);
        this.saveCards();
        
        console.log('üé¥ Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„Çí‰ΩúÊàê:', front.substring(0, 20) + '...');
        return card;
    },
    
    // „Ç´„Éº„ÉâÁ∑®ÈõÜ
    editCard(cardId, updates) {
        const cardIndex = this.cards.findIndex(c => c.id === cardId);
        if (cardIndex === -1) return false;
        
        this.cards[cardIndex] = { ...this.cards[cardIndex], ...updates };
        this.saveCards();
        
        return true;
    },
    
    // „Ç´„Éº„ÉâÂâäÈô§
    deleteCard(cardId) {
        this.cards = this.cards.filter(c => c.id !== cardId);
        this.saveCards();
        
        console.log('üé¥ „Ç´„Éº„Éâ„ÇíÂâäÈô§:', cardId);
    },
    
    // Âæ©ÁøíÂØæË±°„Ç´„Éº„ÉâÂèñÂæó
    getDueCards() {
        const now = new Date();
        return this.cards.filter(card => new Date(card.nextReview) <= now);
    },
    
    // Êñ∞Ë¶è„Ç´„Éº„ÉâÂèñÂæó
    getNewCards(limit = 10) {
        return this.cards
            .filter(card => card.reviews.length === 0)
            .slice(0, limit);
    },
    
    // Â≠¶Áøí„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã
    startSession(deckType = 'mixed', maxCards = 20) {
        let sessionCards = [];
        
        switch(deckType) {
            case 'due':
                sessionCards = this.getDueCards();
                break;
            case 'new':
                sessionCards = this.getNewCards(maxCards);
                break;
            case 'mixed':
                const dueCards = this.getDueCards();
                const newCards = this.getNewCards(Math.max(0, maxCards - dueCards.length));
                sessionCards = [...dueCards, ...newCards];
                break;
            case 'subject':
                // ÁâπÂÆöÁßëÁõÆ„ÅÆ„Ç´„Éº„Éâ„ÇíÂèñÂæó
                sessionCards = this.getSubjectCards(maxCards);
                break;
        }
        
        if (sessionCards.length === 0) {
            alert('Âæ©Áøí„Åô„Çã„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ');
            return false;
        }
        
        // „Ç´„Éº„Éâ„Çí„Ç∑„É£„ÉÉ„Éï„É´
        this.sessionCards = Utils.shuffleArray(sessionCards);
        this.currentCard = 0;
        this.session = {
            correct: 0,
            wrong: 0,
            total: this.sessionCards.length,
            startTime: new Date(),
            isActive: true,
            type: deckType
        };
        
        this.showSessionInterface();
        this.displayCurrentCard();
        
        console.log(`üé¥ Â≠¶Áøí„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã: ${this.session.total}Êûö`);
        return true;
    },
    
    // ÁßëÁõÆÂà•„Ç´„Éº„ÉâÂèñÂæó
    getSubjectCards(limit) {
        // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÁßëÁõÆ„Å´Âü∫„Å•„ÅÑ„Å¶„Ç´„Éº„Éâ„ÇíÂèñÂæó
        const currentSubject = App.currentSubject;
        if (!currentSubject) return [];
        
        return this.cards
            .filter(card => card.subject === currentSubject)
            .slice(0, limit);
    },
    
    // „Çª„ÉÉ„Ç∑„Éß„É≥ÁîªÈù¢Ë°®Á§∫
    showSessionInterface() {
        const container = document.createElement('div');
        container.id = 'flashcard-session';
        container.className = 'flashcard-session-overlay';
        
        container.innerHTML = `
            <div class="flashcard-session-container">
                <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                <div class="flashcard-header">
                    <div class="session-progress">
                        <span id="card-counter">${this.currentCard + 1} / ${this.session.total}</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="session-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                    <button class="close-session-btn" onclick="FlashCardModule.endSession()">‚úï</button>
                </div>
                
                <!-- „Ç´„Éº„ÉâË°®Á§∫„Ç®„É™„Ç¢ -->
                <div class="flashcard-display">
                    <div id="flashcard-container" class="flashcard-container">
                        <div id="flashcard" class="flashcard">
                            <!-- Ë°®Èù¢ -->
                            <div class="card-front">
                                <div class="card-content">
                                    <div class="card-type">ÂïèÈ°å</div>
                                    <div id="card-front-text" class="card-text"></div>
                                </div>
                            </div>
                            
                            <!-- Ë£èÈù¢ -->
                            <div class="card-back">
                                <div class="card-content">
                                    <div class="card-type">Á≠î„Åà</div>
                                    <div id="card-back-text" class="card-text"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
                    <div class="flashcard-controls">
                        <button id="flip-btn" class="control-btn primary" onclick="FlashCardModule.flipCard()">
                            <span>„Ç´„Éº„Éâ„Çí„ÇÅ„Åè„Çã</span>
                            <small>„Çπ„Éö„Éº„Çπ„Ç≠„Éº</small>
                        </button>
                        
                        <div id="rating-buttons" class="rating-buttons" style="display: none;">
                            <div class="rating-instruction">ÁêÜËß£Â∫¶„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                            <div class="rating-grid">
                                <button class="rating-btn again" onclick="FlashCardModule.rateCard(1)">
                                    <span class="rating-icon">üò∞</span>
                                    <span class="rating-label">Again</span>
                                    <small>1</small>
                                </button>
                                <button class="rating-btn hard" onclick="FlashCardModule.rateCard(2)">
                                    <span class="rating-icon">ü§î</span>
                                    <span class="rating-label">Hard</span>
                                    <small>2</small>
                                </button>
                                <button class="rating-btn good" onclick="FlashCardModule.rateCard(3)">
                                    <span class="rating-icon">üòä</span>
                                    <span class="rating-label">Good</span>
                                    <small>3</small>
                                </button>
                                <button class="rating-btn easy" onclick="FlashCardModule.rateCard(4)">
                                    <span class="rating-icon">üòé</span>
                                    <span class="rating-label">Easy</span>
                                    <small>4</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Áµ±Ë®àË°®Á§∫ -->
                <div class="session-stats">
                    <div class="stat-item correct">
                        <div class="stat-value" id="session-correct">0</div>
                        <div class="stat-label">Ê≠£Ëß£</div>
                    </div>
                    <div class="stat-item wrong">
                        <div class="stat-value" id="session-wrong">0</div>
                        <div class="stat-label">‰∏çÊ≠£Ëß£</div>
                    </div>
                    <div class="stat-item time">
                        <div class="stat-value" id="session-time">00:00</div>
                        <div class="stat-label">ÁµåÈÅéÊôÇÈñì</div>
                    </div>
                </div>
                
                <!-- „Ç≠„Éº„Éú„Éº„Éâ„Éò„É´„Éó -->
                <div class="keyboard-help">
                    <small>
                        „Çπ„Éö„Éº„Çπ: „ÇÅ„Åè„Çã | 1-4: Ë©ï‰æ° | ESC: ÁµÇ‰∫Ü
                    </small>
                </div>
            </div>
        `;
        
        // CSS„ÇíÂãïÁöÑ„Å´ËøΩÂä†
        this.addFlashCardCSS();
        
        document.body.appendChild(container);
        
        // „Çø„Ç§„Éû„ÉºÈñãÂßã
        this.startSessionTimer();
    },
    
    // ÁèæÂú®„ÅÆ„Ç´„Éº„ÉâË°®Á§∫
    displayCurrentCard() {
        if (this.currentCard >= this.sessionCards.length) {
            this.showSessionResults();
            return;
        }
        
        const card = this.sessionCards[this.currentCard];
        
        // „Ç´„Éº„ÉâÂÜÖÂÆπÊõ¥Êñ∞
        Utils.updateElement('card-front-text', card.front);
        Utils.updateElement('card-back-text', card.back);
        
        // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞
        const progress = ((this.currentCard + 1) / this.session.total) * 100;
        Utils.updateElement('card-counter', `${this.currentCard + 1} / ${this.session.total}`);
        
        const progressBar = document.getElementById('session-progress');
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }
        
        // „Ç´„Éº„Éâ„É™„Çª„ÉÉ„Éà
        this.resetCardDisplay();
    },
    
    // „Ç´„Éº„ÉâË°®Á§∫„É™„Çª„ÉÉ„Éà
    resetCardDisplay() {
        const flashcard = document.getElementById('flashcard');
        if (flashcard) {
            flashcard.classList.remove('flipped');
        }
        
        const flipBtn = document.getElementById('flip-btn');
        const ratingButtons = document.getElementById('rating-buttons');
        
        if (flipBtn) flipBtn.style.display = 'block';
        if (ratingButtons) ratingButtons.style.display = 'none';
    },
    
    // „Ç´„Éº„Éâ„ÇÅ„Åè„Çä
    flipCard() {
        const flashcard = document.getElementById('flashcard');
        const flipBtn = document.getElementById('flip-btn');
        const ratingButtons = document.getElementById('rating-buttons');
        
        if (flashcard) {
            flashcard.classList.add('flipped');
        }
        
        if (flipBtn) flipBtn.style.display = 'none';
        if (ratingButtons) ratingButtons.style.display = 'block';
    },
    
    // „Ç´„Éº„ÉâË©ï‰æ°ÔºàSM-2„Ç¢„É´„Ç¥„É™„Ç∫„É†Ôºâ
    rateCard(quality) {
        const card = this.sessionCards[this.currentCard];
        this.updateCardWithSM2(card, quality);
        
        // „Çª„ÉÉ„Ç∑„Éß„É≥Áµ±Ë®àÊõ¥Êñ∞
        if (quality >= this.SM2_CONFIG.QUALITY_THRESHOLD) {
            this.session.correct++;
        } else {
            this.session.wrong++;
        }
        
        this.updateSessionStats();
        
        // Ê¨°„ÅÆ„Ç´„Éº„Éâ„Å∏
        this.currentCard++;
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„ÅßÊ¨°„ÅÆ„Ç´„Éº„Éâ„ÇíË°®Á§∫
        setTimeout(() => {
            this.displayCurrentCard();
        }, 300);
        
        // „Éè„Éó„ÉÜ„Ç£„ÉÉ„ÇØ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
        Utils.hapticFeedback();
    },
    
    // SM-2„Ç¢„É´„Ç¥„É™„Ç∫„É†„Åß„Ç´„Éº„ÉâÊõ¥Êñ∞
    updateCardWithSM2(card, quality) {
        const now = new Date();
        
        // Âæ©ÁøíË®òÈå≤ËøΩÂä†
        card.reviews.push({
            date: now.toISOString(),
            quality: quality,
            interval: card.interval,
            easeFactor: card.easeFactor
        });
        
        card.lastReviewed = now.toISOString();
        
        // SM-2„Ç¢„É´„Ç¥„É™„Ç∫„É†ÈÅ©Áî®
        if (quality >= this.SM2_CONFIG.QUALITY_THRESHOLD) {
            // Ê≠£Ëß£„ÅÆÂ†¥Âêà
            if (card.repetitions === 0) {
                card.interval = 1;
            } else if (card.repetitions === 1) {
                card.interval = 6;
            } else {
                card.interval = Math.round(card.interval * card.easeFactor);
            }
            card.repetitions++;
            card.isLearning = false;
        } else {
            // ‰∏çÊ≠£Ëß£„ÅÆÂ†¥Âêà
            card.repetitions = 0;
            card.interval = 1;
            card.isLearning = true;
            card.lapses++;
        }
        
        // ÂÆπÊòìÂ∫¶Âõ†Â≠êÊõ¥Êñ∞
        const adjustment = this.SM2_CONFIG.EASE_ADJUSTMENT[quality] || 0;
        card.easeFactor = Math.max(
            this.SM2_CONFIG.MIN_EASE_FACTOR,
            card.easeFactor + adjustment
        );
        
        // Ê¨°ÂõûÂæ©ÁøíÊó•Ë®≠ÂÆö
        const nextReview = new Date(now);
        nextReview.setDate(nextReview.getDate() + card.interval);
        card.nextReview = nextReview.toISOString();
        
        this.saveCards();
        
        console.log(`üé¥ „Ç´„Éº„ÉâË©ï‰æ°: quality=${quality}, interval=${card.interval}Êó•, ease=${card.easeFactor.toFixed(2)}`);
    },
    
    // „Çª„ÉÉ„Ç∑„Éß„É≥Áµ±Ë®àÊõ¥Êñ∞
    updateSessionStats() {
        Utils.updateElement('session-correct', this.session.correct);
        Utils.updateElement('session-wrong', this.session.wrong);
    },
    
    // „Çª„ÉÉ„Ç∑„Éß„É≥„Çø„Ç§„Éû„ÉºÈñãÂßã
    startSessionTimer() {
        this.sessionTimer = setInterval(() => {
            if (this.session.startTime) {
                const elapsed = Math.floor((new Date() - this.session.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                Utils.updateElement('session-time', `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
            }
        }, 1000);
    },
    
    // „Çª„ÉÉ„Ç∑„Éß„É≥ÁµêÊûúË°®Á§∫
    showSessionResults() {
        const duration = Math.floor((new Date() - this.session.startTime) / 1000);
        const accuracy = this.session.total > 0 ? Math.round((this.session.correct / this.session.total) * 100) : 0;
        
        const container = document.getElementById('flashcard-session');
        
        container.innerHTML = `
            <div class="session-results">
                <div class="results-header">
                    <h2>üéâ Â≠¶ÁøíÂÆå‰∫ÜÔºÅ</h2>
                    <p>„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„Åü</p>
                </div>
                
                <div class="results-stats">
                    <div class="result-item">
                        <div class="result-value">${this.session.total}</div>
                        <div class="result-label">„Ç´„Éº„ÉâÊï∞</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${this.session.correct}</div>
                        <div class="result-label">Ê≠£Ëß£</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${this.session.wrong}</div>
                        <div class="result-label">‰∏çÊ≠£Ëß£</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${accuracy}%</div>
                        <div class="result-label">Ê≠£Á≠îÁéá</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value">${Math.floor(duration / 60)}:${String(duration % 60).padStart(2, '0')}</div>
                        <div class="result-label">Â≠¶ÁøíÊôÇÈñì</div>
                    </div>
                </div>
                
                <div class="results-actions">
                    <button class="control-btn primary" onclick="FlashCardModule.startSession('mixed')">
                        „ÇÇ„ÅÜ‰∏ÄÂ∫¶Â≠¶Áøí
                    </button>
                    <button class="control-btn secondary" onclick="FlashCardModule.endSession()">
                        ÁµÇ‰∫Ü
                    </button>
                </div>
                
                <div class="next-review-info">
                    <p>Ê¨°ÂõûÂæ©Áøí‰∫àÂÆö: ${this.getNextReviewInfo()}</p>
                </div>
            </div>
        `;
        
        // Â≠¶ÁøíË®òÈå≤„Çí‰øùÂ≠ò
        this.saveSessionRecord(duration, accuracy);
    },
    
    // Ê¨°ÂõûÂæ©ÁøíÊÉÖÂ†±ÂèñÂæó
    getNextReviewInfo() {
        const dueCards = this.getDueCards();
        if (dueCards.length > 0) {
            return `${dueCards.length}Êûö„ÅÆ„Ç´„Éº„Éâ„ÅåÂæ©ÁøíÂæÖ„Å°„Åß„Åô`;
        }
        
        // ÊúÄ„ÇÇÊó©„ÅÑÊ¨°ÂõûÂæ©ÁøíÊó•„ÇíÂèñÂæó
        const nextDue = this.cards
            .filter(card => card.nextReview)
            .map(card => new Date(card.nextReview))
            .sort((a, b) => a - b)[0];
        
        if (nextDue) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (nextDue <= tomorrow) {
                return 'ÊòéÊó•';
            } else {
                return Utils.formatDate(nextDue, 'MM/DD');
            }
        }
        
        return 'Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
    },
    
    // „Çª„ÉÉ„Ç∑„Éß„É≥Ë®òÈå≤‰øùÂ≠ò
    saveSessionRecord(duration, accuracy) {
        const record = {
            id: Utils.generateId(),
            type: 'flashcard',
            date: new Date().toISOString(),
            duration: duration,
            cardsStudied: this.session.total,
            correct: this.session.correct,
            wrong: this.session.wrong,
            accuracy: accuracy,
            sessionType: this.session.type
        };
        
        // Êó¢Â≠ò„ÅÆÂ≠¶ÁøíÂ±•Ê≠¥„Å´ËøΩÂä†
        const history = StorageModule.getHistory();
        history.unshift(record);
        Utils.safeLocalStorage.set('studyHistory', history);
        
        console.log('üé¥ ÊöóË®ò„Ç´„Éº„Éâ„Çª„ÉÉ„Ç∑„Éß„É≥Ë®òÈå≤„Çí‰øùÂ≠ò:', record);
    },
    
    // „Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü
    endSession() {
        this.session.isActive = false;
        
        if (this.sessionTimer) {
            clearInterval(this.sessionTimer);
            this.sessionTimer = null;
        }
        
        const container = document.getElementById('flashcard-session');
        if (container) {
            container.remove();
        }
        
        console.log('üé¥ ÊöóË®ò„Ç´„Éº„Éâ„Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü');
    },
    
    // ÊöóË®ò„Ç´„Éº„ÉâÁÆ°ÁêÜÁîªÈù¢Ë°®Á§∫
    showManagementInterface() {
        const container = document.createElement('div');
        container.id = 'flashcard-management';
        container.innerHTML = `
            <div class="management-container">
                <div class="management-header">
                    <h2>üé¥ ÊöóË®ò„Ç´„Éº„ÉâÁÆ°ÁêÜ</h2>
                    <button class="close-btn" onclick="FlashCardModule.closeManagement()">‚úï</button>
                </div>
                
                <div class="management-tabs">
                    <button class="tab-btn active" onclick="FlashCardModule.showTab('overview')">Ê¶ÇË¶Å</button>
                    <button class="tab-btn" onclick="FlashCardModule.showTab('create')">„Ç´„Éº„Éâ‰ΩúÊàê</button>
                    <button class="tab-btn" onclick="FlashCardModule.showTab('browse')">„Ç´„Éº„Éâ‰∏ÄË¶ß</button>
                    <button class="tab-btn" onclick="FlashCardModule.showTab('stats')">Áµ±Ë®à</button>
                </div>
                
                <div class="management-content">
                    <div id="overview-tab" class="tab-content active">
                        ${this.generateOverviewHTML()}
                    </div>
                    
                    <div id="create-tab" class="tab-content">
                        ${this.generateCreateHTML()}
                    </div>
                    
                    <div id="browse-tab" class="tab-content">
                        ${this.generateBrowseHTML()}
                    </div>
                    
                    <div id="stats-tab" class="tab-content">
                        ${this.generateStatsHTML()}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(container);
    },
    
    // Ê¶ÇË¶ÅHTMLÁîüÊàê
    generateOverviewHTML() {
        const dueCards = this.getDueCards();
        const newCards = this.getNewCards();
        const totalCards = this.cards.length;
        
        return `
            <div class="overview-stats">
                <div class="stat-card">
                    <div class="stat-number">${totalCards}</div>
                    <div class="stat-label">Á∑è„Ç´„Éº„ÉâÊï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${dueCards.length}</div>
                    <div class="stat-label">Âæ©ÁøíÂæÖ„Å°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${newCards.length}</div>
                    <div class="stat-label">Êñ∞Ë¶è„Ç´„Éº„Éâ</div>
                </div>
            </div>
            
            <div class="quick-actions">
                <button class="action-btn primary" onclick="FlashCardModule.startSession('mixed')" ${dueCards.length === 0 && newCards.length === 0 ? 'disabled' : ''}>
                    Â≠¶ÁøíÈñãÂßã
                </button>
                <button class="action-btn secondary" onclick="FlashCardModule.startSession('due')" ${dueCards.length === 0 ? 'disabled' : ''}>
                    Âæ©Áøí„ÅÆ„Åø
                </button>
                <button class="action-btn secondary" onclick="FlashCardModule.startSession('new')" ${newCards.length === 0 ? 'disabled' : ''}>
                    Êñ∞Ë¶è„ÅÆ„Åø
                </button>
            </div>
        `;
    },
    
    // ‰ΩúÊàêHTMLÁîüÊàê
    generateCreateHTML() {
        return `
            <form id="card-create-form" onsubmit="FlashCardModule.handleCreateCard(event)">
                <div class="form-group">
                    <label for="card-front">ÂïèÈ°åÔºàË°®Èù¢Ôºâ</label>
                    <textarea id="card-front" placeholder="ÂïèÈ°åÊñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="card-back">Á≠î„ÅàÔºàË£èÈù¢Ôºâ</label>
                    <textarea id="card-back" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="card-subject">ÁßëÁõÆ</label>
                    <select id="card-subject">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="minpou">Ê∞ëÊ≥ï</option>
                        <option value="gyousei">Ë°åÊîøÊ≥ï</option>
                        <option value="kenpou">ÊÜ≤Ê≥ï</option>
                        <option value="shouhou">ÂïÜÊ≥ï</option>
                        <option value="kiso">Âü∫Á§éÊ≥ïÂ≠¶</option>
                        <option value="ippan">‰∏ÄËà¨Áü•Ë≠ò</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="card-tags">„Çø„Ç∞Ôºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ</label>
                    <input type="text" id="card-tags" placeholder="Êù°Êñá, Âà§‰æã, ÈáçË¶Å" />
                </div>
                
                <button type="submit" class="submit-btn">„Ç´„Éº„Éâ‰ΩúÊàê</button>
            </form>
        `;
    },
    
    // ‰∏ÄË¶ßHTMLÁîüÊàê
    generateBrowseHTML() {
        if (this.cards.length === 0) {
            return '<p class="empty-message">„Åæ„Å†„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
        }
        
        return `
            <div class="browse-controls">
                <input type="text" id="search-cards" placeholder="„Ç´„Éº„Éâ„ÇíÊ§úÁ¥¢..." oninput="FlashCardModule.filterCards()" />
                <select id="filter-subject" onchange="FlashCardModule.filterCards()">
                    <option value="">ÂÖ®ÁßëÁõÆ</option>
                    <option value="minpou">Ê∞ëÊ≥ï</option>
                    <option value="gyousei">Ë°åÊîøÊ≥ï</option>
                    <option value="kenpou">ÊÜ≤Ê≥ï</option>
                    <option value="shouhou">ÂïÜÊ≥ï</option>
                    <option value="kiso">Âü∫Á§éÊ≥ïÂ≠¶</option>
                    <option value="ippan">‰∏ÄËà¨Áü•Ë≠ò</option>
                </select>
            </div>
            
            <div id="cards-list">
                ${this.generateCardsList()}
            </div>
        `;
    },
    
    // „Ç´„Éº„Éâ‰∏ÄË¶ßÁîüÊàê
    generateCardsList() {
        return this.cards.map(card => `
            <div class="card-item" data-card-id="${card.id}">
                <div class="card-preview">
                    <div class="card-front-preview">${card.front.substring(0, 100)}...</div>
                    <div class="card-back-preview">${card.back.substring(0, 100)}...</div>
                </div>
                <div class="card-meta">
                    <span class="card-subject">${this.getSubjectName(card.subject)}</span>
                    <span class="card-interval">ÈñìÈöî: ${card.interval}Êó•</span>
                    <span class="card-ease">ÂÆπÊòìÂ∫¶: ${card.easeFactor.toFixed(2)}</span>
                </div>
                <div class="card-actions">
                    <button onclick="FlashCardModule.editCard('${card.id}')">Á∑®ÈõÜ</button>
                    <button onclick="FlashCardModule.deleteCard('${card.id}')" class="delete-btn">ÂâäÈô§</button>
                </div>
            </div>
        `).join('');
    },
    
    // ÁßëÁõÆÂêçÂèñÂæó
    getSubjectName(subjectCode) {
        const subjects = {
            minpou: 'Ê∞ëÊ≥ï',
            gyousei: 'Ë°åÊîøÊ≥ï',
            kenpou: 'ÊÜ≤Ê≥ï',
            shouhou: 'ÂïÜÊ≥ï',
            kiso: 'Âü∫Á§éÊ≥ïÂ≠¶',
            ippan: '‰∏ÄËà¨Áü•Ë≠ò'
        };
        return subjects[subjectCode] || 'Êú™ÂàÜÈ°û';
    },
    
    // Áµ±Ë®àHTMLÁîüÊàê
    generateStatsHTML() {
        const stats = this.calculateStats();
        
        return `
            <div class="stats-grid">
                <div class="stat-item">
                    <h3>Â≠¶ÁøíÁµ±Ë®à</h3>
                    <p>Á∑èÂæ©ÁøíÂõûÊï∞: ${stats.totalReviews}</p>
                    <p>Âπ≥ÂùáÊ≠£Á≠îÁéá: ${stats.averageAccuracy}%</p>
                    <p>Â≠¶ÁøíÊó•Êï∞: ${stats.studyDays}</p>
                </div>
                
                <div class="stat-item">
                    <h3>„Ç´„Éº„ÉâÁµ±Ë®à</h3>
                    <p>Â≠¶ÁøíÊ∏à„Åø: ${stats.matureCards}</p>
                    <p>Â≠¶Áøí‰∏≠: ${stats.learningCards}</p>
                    <p>Êñ∞Ë¶è: ${stats.newCards}</p>
                </div>
                
                <div class="stat-item">
                    <h3>ÁßëÁõÆÂà•Áµ±Ë®à</h3>
                    ${Object.entries(stats.subjectStats).map(([subject, count]) => 
                        `<p>${this.getSubjectName(subject)}: ${count}Êûö</p>`
                    ).join('')}
                </div>
            </div>
        `;
    },
    
    // Áµ±Ë®àË®àÁÆó
    calculateStats() {
        const stats = {
            totalReviews: 0,
            averageAccuracy: 0,
            studyDays: new Set(),
            matureCards: 0,
            learningCards: 0,
            newCards: 0,
            subjectStats: {}
        };
        
        let totalQuality = 0;
        let qualityCount = 0;
        
        this.cards.forEach(card => {
            stats.totalReviews += card.reviews.length;
            
            // Âæ©ÁøíÊó•„ÇíË®òÈå≤
            card.reviews.forEach(review => {
                const date = new Date(review.date).toDateString();
                stats.studyDays.add(date);
                totalQuality += review.quality;
                qualityCount++;
            });
            
            // „Ç´„Éº„ÉâÁä∂ÊÖãÂàÜÈ°û
            if (card.reviews.length === 0) {
                stats.newCards++;
            } else if (card.isLearning) {
                stats.learningCards++;
            } else {
                stats.matureCards++;
            }
            
            // ÁßëÁõÆÂà•Áµ±Ë®à
            if (card.subject) {
                stats.subjectStats[card.subject] = (stats.subjectStats[card.subject] || 0) + 1;
            }
        });
        
        stats.averageAccuracy = qualityCount > 0 ? Math.round((totalQuality / qualityCount) * 20) : 0; // quality 0-5 „Çí 0-100% „Å´Â§âÊèõ
        stats.studyDays = stats.studyDays.size;
        
        return stats;
    },
    
    // „Ç´„Éº„Éâ‰ΩúÊàê„Éï„Ç©„Éº„É†Âá¶ÁêÜ
    handleCreateCard(event) {
        event.preventDefault();
        
        const front = document.getElementById('card-front').value.trim();
        const back = document.getElementById('card-back').value.trim();
        const subject = document.getElementById('card-subject').value;
        const tagsInput = document.getElementById('card-tags').value.trim();
        const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()) : [];
        
        if (!front || !back) {
            alert('ÂïèÈ°å„Å®Á≠î„Åà„ÅÆ‰∏°Êñπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }
        
        this.createCard(front, back, tags, subject);
        
        // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
        event.target.reset();
        
        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
        this.showToast('„Ç´„Éº„Éâ„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
        
        // Ê¶ÇË¶Å„Çø„Éñ„ÇíÊõ¥Êñ∞
        this.updateOverviewTab();
    },
    
    // „Ç´„Éº„Éâ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
    filterCards() {
        const searchTerm = document.getElementById('search-cards').value.toLowerCase();
        const subjectFilter = document.getElementById('filter-subject').value;
        
        let filteredCards = this.cards;
        
        if (searchTerm) {
            filteredCards = filteredCards.filter(card => 
                card.front.toLowerCase().includes(searchTerm) ||
                card.back.toLowerCase().includes(searchTerm) ||
                card.tags.some(tag => tag.toLowerCase().includes(searchTerm))
            );
        }
        
        if (subjectFilter) {
            filteredCards = filteredCards.filter(card => card.subject === subjectFilter);
        }
        
        const cardsList = document.getElementById('cards-list');
        if (cardsList) {
            cardsList.innerHTML = this.generateCardsListFromArray(filteredCards);
        }
    },
    
    // ÊåáÂÆö„Ç´„Éº„ÉâÈÖçÂàó„Åã„Çâ„É™„Çπ„ÉàÁîüÊàê
    generateCardsListFromArray(cards) {
        if (cards.length === 0) {
            return '<p class="empty-message">Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„Çã„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
        }
        
        return cards.map(card => `
            <div class="card-item" data-card-id="${card.id}">
                <div class="card-preview">
                    <div class="card-front-preview">${card.front.substring(0, 100)}${card.front.length > 100 ? '...' : ''}</div>
                    <div class="card-back-preview">${card.back.substring(0, 100)}${card.back.length > 100 ? '...' : ''}</div>
                </div>
                <div class="card-meta">
                    <span class="card-subject">${this.getSubjectName(card.subject)}</span>
                    <span class="card-interval">ÈñìÈöî: ${card.interval}Êó•</span>
                    <span class="card-ease">ÂÆπÊòìÂ∫¶: ${card.easeFactor.toFixed(2)}</span>
                    <span class="card-reviews">Âæ©Áøí: ${card.reviews.length}Âõû</span>
                </div>
                <div class="card-actions">
                    <button onclick="FlashCardModule.editCardDialog('${card.id}')">Á∑®ÈõÜ</button>
                    <button onclick="FlashCardModule.confirmDeleteCard('${card.id}')" class="delete-btn">ÂâäÈô§</button>
                </div>
            </div>
        `).join('');
    },
    
    // „Ç´„Éº„ÉâÁ∑®ÈõÜ„ÉÄ„Ç§„Ç¢„É≠„Ç∞
    editCardDialog(cardId) {
        const card = this.cards.find(c => c.id === cardId);
        if (!card) return;
        
        const front = prompt('ÂïèÈ°å„ÇíÁ∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', card.front);
        if (front === null) return;
        
        const back = prompt('Á≠î„Åà„ÇíÁ∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', card.back);
        if (back === null) return;
        
        this.editCard(cardId, { front: front.trim(), back: back.trim() });
        this.updateBrowseTab();
        this.showToast('„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
    },
    
    // „Ç´„Éº„ÉâÂâäÈô§Á¢∫Ë™ç
    confirmDeleteCard(cardId) {
        if (confirm('„Åì„ÅÆ„Ç´„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
            this.deleteCard(cardId);
            this.updateBrowseTab();
            this.updateOverviewTab();
            this.showToast('„Ç´„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'info');
        }
    },
    
    // „Çø„ÉñË°®Á§∫Âàá„ÇäÊõø„Åà
    showTab(tabName) {
        // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`button[onclick="FlashCardModule.showTab('${tabName}')"]`).classList.add('active');
        
        // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // „Çø„Éñ„Åî„Å®„ÅÆÊõ¥Êñ∞Âá¶ÁêÜ
        switch(tabName) {
            case 'overview':
                this.updateOverviewTab();
                break;
            case 'browse':
                this.updateBrowseTab();
                break;
            case 'stats':
                this.updateStatsTab();
                break;
        }
    },
    
    // Ê¶ÇË¶Å„Çø„ÉñÊõ¥Êñ∞
    updateOverviewTab() {
        const overviewTab = document.getElementById('overview-tab');
        if (overviewTab) {
            overviewTab.innerHTML = this.generateOverviewHTML();
        }
    },
    
    // ‰∏ÄË¶ß„Çø„ÉñÊõ¥Êñ∞
    updateBrowseTab() {
        const browseTab = document.getElementById('browse-tab');
        if (browseTab) {
            browseTab.innerHTML = this.generateBrowseHTML();
        }
    },
    
    // Áµ±Ë®à„Çø„ÉñÊõ¥Êñ∞
    updateStatsTab() {
        const statsTab = document.getElementById('stats-tab');
        if (statsTab) {
            statsTab.innerHTML = this.generateStatsHTML();
        }
    },
    
    // ÁÆ°ÁêÜÁîªÈù¢„ÇíÈñâ„Åò„Çã
    closeManagement() {
        const container = document.getElementById('flashcard-management');
        if (container) {
            container.remove();
        }
    },
    
    // „Éà„Éº„Çπ„ÉàÈÄöÁü•Ë°®Á§∫
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    },
    
    // ÊöóË®ò„Ç´„Éº„ÉâÁî®CSSËøΩÂä†
    addFlashCardCSS() {
        if (document.getElementById('flashcard-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'flashcard-styles';
        style.textContent = `
            .flashcard-session-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
            
            .flashcard-session-container {
                background: white;
                border-radius: 16px;
                width: 100%;
                max-width: 600px;
                max-height: 90vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }
            
            .flashcard-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #eee;
            }
            
            .session-progress {
                flex: 1;
            }
            
            .close-session-btn {
                background: #f44336;
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 18px;
            }
            
            .flashcard-display {
                padding: 20px;
                flex: 1;
            }
            
            .flashcard-container {
                perspective: 1000px;
                margin-bottom: 30px;
            }
            
            .flashcard {
                position: relative;
                width: 100%;
                height: 300px;
                transition: transform 0.6s;
                transform-style: preserve-3d;
                cursor: pointer;
            }
            
            .flashcard.flipped {
                transform: rotateY(180deg);
            }
            
            .card-front, .card-back {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 30px;
            }
            
            .card-front {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
            }
            
            .card-back {
                background: linear-gradient(135deg, #f093fb, #f5576c);
                color: white;
                transform: rotateY(180deg);
            }
            
            .card-content {
                text-align: center;
                width: 100%;
            }
            
            .card-type {
                font-size: 14px;
                opacity: 0.9;
                margin-bottom: 15px;
                font-weight: bold;
            }
            
            .card-text {
                font-size: 18px;
                line-height: 1.6;
                word-wrap: break-word;
            }
            
            .flashcard-controls {
                text-align: center;
            }
            
            .control-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .control-btn.primary {
                background: #667eea;
                color: white;
            }
            
            .control-btn.secondary {
                background: #f5f5f5;
                color: #333;
            }
            
            .rating-buttons {
                margin-top: 20px;
            }
            
            .rating-instruction {
                margin-bottom: 15px;
                font-size: 14px;
                color: #666;
            }
            
            .rating-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            .rating-btn {
                padding: 15px 10px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-align: center;
                transition: all 0.2s;
                font-size: 12px;
            }
            
            .rating-btn.again { background: #ffebee; color: #f44336; }
            .rating-btn.hard { background: #fff3e0; color: #ff9800; }
            .rating-btn.good { background: #e8f5e9; color: #4caf50; }
            .rating-btn.easy { background: #e3f2fd; color: #2196f3; }
            
            .rating-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .rating-icon {
                display: block;
                font-size: 24px;
                margin-bottom: 5px;
            }
            
            .rating-label {
                display: block;
                font-weight: bold;
                margin-bottom: 2px;
            }
            
            .session-stats {
                display: flex;
                justify-content: space-around;
                padding: 20px;
                border-top: 1px solid #eee;
                background: #f8f9fa;
            }
            
            .stat-item {
                text-align: center;
            }
            
            .stat-value {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .stat-item.correct .stat-value { color: #4caf50; }
            .stat-item.wrong .stat-value { color: #f44336; }
            .stat-item.time .stat-value { color: #667eea; }
            
            .stat-label {
                font-size: 12px;
                color: #666;
            }
            
            .keyboard-help {
                text-align: center;
                padding: 10px 20px;
                background: #f0f0f0;
                color: #666;
            }
            
            .session-results {
                padding: 40px;
                text-align: center;
            }
            
            .results-header h2 {
                color: #4caf50;
                margin-bottom: 10px;
            }
            
            .results-stats {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                margin: 30px 0;
            }
            
            .result-item {
                text-align: center;
            }
            
            .result-value {
                font-size: 32px;
                font-weight: bold;
                color: #667eea;
                margin-bottom: 5px;
            }
            
            .result-label {
                font-size: 14px;
                color: #666;
            }
            
            .results-actions {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin: 30px 0;
            }
            
            .next-review-info {
                font-size: 14px;
                color: #666;
                margin-top: 20px;
            }
            
            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 20000;
                transform: translateX(100%);
                transition: transform 0.3s;
            }
            
            .toast.show {
                transform: translateX(0);
            }
            
            .toast-success { background: #4caf50; }
            .toast-info { background: #2196f3; }
            .toast-warning { background: #ff9800; }
            .toast-error { background: #f44336; }
            
            @media (max-width: 600px) {
                .flashcard-session-container {
                    margin: 10px;
                    max-height: 95vh;
                }
                
                .rating-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                }
                
                .card-text {
                    font-size: 16px;
                }
                
                .results-stats {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
        `;
        
        document.head.appendChild(style);
    },
    
    // ‰∫àÁøí„Ç´„Éº„ÉâËá™ÂãïÁîüÊàêÔºàAIÊ©üËÉΩ„Å®ÈÄ£Êê∫Ôºâ
    generateCardsFromHistory() {
        const history = StorageModule.getHistory();
        const weakAreas = this.identifyWeakAreas(history);
        
        const generatedCards = [];
        
        weakAreas.forEach(area => {
            // Âº±ÁÇπ„Ç®„É™„Ç¢„Å´Âü∫„Å•„ÅÑ„Å¶„Ç´„Éº„Éâ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁîüÊàê
            const templates = this.getCardTemplates(area.subject, area.topic);
            templates.forEach(template => {
                const card = this.createCard(
                    template.front,
                    template.back,
                    [area.subject, area.topic, 'Ëá™ÂãïÁîüÊàê'],
                    area.subject
                );
                generatedCards.push(card);
            });
        });
        
        console.log(`üé¥ ${generatedCards.length}Êûö„ÅÆ„Ç´„Éº„Éâ„ÇíËá™ÂãïÁîüÊàê„Åó„Åæ„Åó„Åü`);
        return generatedCards;
    },
    
    // Âº±ÁÇπ„Ç®„É™„Ç¢ÁâπÂÆö
    identifyWeakAreas(history) {
        const subjectAccuracy = {};
        
        history.forEach(record => {
            if (record.subject) {
                if (!subjectAccuracy[record.subject]) {
                    subjectAccuracy[record.subject] = { total: 0, correct: 0 };
                }
                subjectAccuracy[record.subject].total += record.stats.total || 0;
                subjectAccuracy[record.subject].correct += record.stats.correct || 0;
            }
        });
        
        return Object.keys(subjectAccuracy)
            .filter(subject => {
                const data = subjectAccuracy[subject];
                const accuracy = data.total > 0 ? (data.correct / data.total) * 100 : 0;
                return accuracy < 70 && data.total >= 10; // Ê≠£Á≠îÁéá70%Êú™Ê∫Ä„Åã„Å§10Âïè‰ª•‰∏ä
            })
            .map(subject => ({
                subject: subject,
                topic: 'general', // ÂÆüÈöõ„Å´„ÅØ„Çà„ÇäË©≥Á¥∞„Å™ÂàÜÊûê„ÅåÂøÖË¶Å
                accuracy: Math.round((subjectAccuracy[subject].correct / subjectAccuracy[subject].total) * 100)
            }));
    },
    
    // „Ç´„Éº„Éâ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂèñÂæó
    getCardTemplates(subject, topic) {
        const templates = {
            minpou: [
                {
                    front: 'Â•ëÁ¥Ñ„ÅÆÊàêÁ´ãË¶Å‰ª∂„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                    back: '‚ë†Áî≥Ëæº„Åø ‚ë°ÊâøË´æ ‚ë¢ÂØæ‰æ°Èñ¢‰øÇÔºàÊúâÂÑüÂ•ëÁ¥Ñ„ÅÆÂ†¥ÂêàÔºâ'
                },
                {
                    front: 'ÊÑèÊÄùË°®Á§∫„ÅÆÁëïÁñµ„Å´„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü',
                    back: '‚ë†ÂøÉË£°Áïô‰øù ‚ë°ËôöÂÅΩË°®Á§∫ ‚ë¢ÈåØË™§ ‚ë£Ë©êÊ¨∫ ‚ë§Âº∑Ëø´'
                }
            ],
            gyousei: [
                {
                    front: 'Ë°åÊîøË°åÁÇ∫„ÅÆÂäπÂäõ„Å´„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü',
                    back: '‚ë†ÂÖ¨ÂÆöÂäõ ‚ë°Á¢∫ÂÆöÂäõ ‚ë¢Â≠òÁ∂öÂäõ ‚ë£Âü∑Ë°åÂäõ'
                },
                {
                    front: 'Ë°åÊîøÂá¶ÂàÜ„ÅÆÂèñÊ∂à‰∫ãÁî±„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                    back: '‚ë†ÈÅïÊ≥ïÊÄß ‚ë°Ë£ÅÈáèÊ®©„ÅÆÈÄ∏ËÑ±„ÉªÊø´Áî®'
                }
            ],
            kenpou: [
                {
                    front: 'Âü∫Êú¨ÁöÑ‰∫∫Ê®©„ÅÆÂàÜÈ°û„ÇíËø∞„Åπ„Å¶„Åè„Å†„Åï„ÅÑ',
                    back: '‚ë†Ëá™Áî±Ê®© ‚ë°ÂèÇÊîøÊ®© ‚ë¢Á§æ‰ºöÊ®© ‚ë£ÂõΩÂãôË´ãÊ±ÇÊ®©'
                }
            ]
        };
        
        return templates[subject] || [];
    },
    
    // Â≠¶ÁøíÂäπÊûúÂàÜÊûê
    analyzeLearningEffectiveness() {
        const analysis = {
            retentionRate: this.calculateRetentionRate(),
            optimalReviewInterval: this.calculateOptimalInterval(),
            difficultyDistribution: this.calculateDifficultyDistribution(),
            learningProgress: this.calculateLearningProgress()
        };
        
        return analysis;
    },
    
    // Ë®òÊÜ∂ÂÆöÁùÄÁéáË®àÁÆó
    calculateRetentionRate() {
        const recentReviews = this.cards
            .flatMap(card => card.reviews)
            .filter(review => {
                const reviewDate = new Date(review.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return reviewDate >= weekAgo;
            });
        
        if (recentReviews.length === 0) return 0;
        
        const correctReviews = recentReviews.filter(review => review.quality >= 3).length;
        return Math.round((correctReviews / recentReviews.length) * 100);
    },
    
    // ÊúÄÈÅ©Âæ©ÁøíÈñìÈöîË®àÁÆó
    calculateOptimalInterval() {
        const intervalEffectiveness = {};
        
        this.cards.forEach(card => {
            card.reviews.forEach((review, index) => {
                if (index > 0) {
                    const interval = card.reviews[index - 1].interval;
                    if (!intervalEffectiveness[interval]) {
                        intervalEffectiveness[interval] = { total: 0, correct: 0 };
                    }
                    intervalEffectiveness[interval].total++;
                    if (review.quality >= 3) {
                        intervalEffectiveness[interval].correct++;
                    }
                }
            });
        });
        
        let bestInterval = 1;
        let bestAccuracy = 0;
        
        Object.keys(intervalEffectiveness).forEach(interval => {
            const data = intervalEffectiveness[interval];
            const accuracy = data.total > 0 ? (data.correct / data.total) * 100 : 0;
            if (accuracy > bestAccuracy && data.total >= 5) {
                bestAccuracy = accuracy;
                bestInterval = parseInt(interval);
            }
        });
        
        return { interval: bestInterval, accuracy: Math.round(bestAccuracy) };
    },
    
    // Èõ£ÊòìÂ∫¶ÂàÜÂ∏ÉË®àÁÆó
    calculateDifficultyDistribution() {
        const distribution = { easy: 0, medium: 0, hard: 0 };
        
        this.cards.forEach(card => {
            if (card.reviews.length > 0) {
                const avgQuality = card.reviews.reduce((sum, r) => sum + r.quality, 0) / card.reviews.length;
                if (avgQuality >= 4) distribution.easy++;
                else if (avgQuality >= 2) distribution.medium++;
                else distribution.hard++;
            }
        });
        
        return distribution;
    },
    
    // Â≠¶ÁøíÈÄ≤ÊçóË®àÁÆó
    calculateLearningProgress() {
        const total = this.cards.length;
        if (total === 0) return { progress: 0, stage: 'empty' };
        
        const mature = this.cards.filter(card => !card.isLearning && card.interval >= 21).length;
        const learning = this.cards.filter(card => card.isLearning).length;
        const newCards = this.cards.filter(card => card.reviews.length === 0).length;
        
        const progress = Math.round((mature / total) * 100);
        
        let stage;
        if (progress >= 80) stage = 'advanced';
        else if (progress >= 50) stage = 'intermediate';
        else if (progress >= 20) stage = 'beginner';
        else stage = 'starting';
        
        return {
            progress,
            stage,
            mature,
            learning,
            newCards,
            total
        };
    }
};

// ===== „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ =====
function startFlashCardSession() {
    FlashCardModule.startSession('mixed');
}

function showFlashCardManagement() {
    FlashCardModule.showManagementInterface();
}

function flipCard() {
    FlashCardModule.flipCard();
}

function rateCard(quality) {
    FlashCardModule.rateCard(quality);
}

// ===== ÂàùÊúüÂåñ =====
document.addEventListener('DOMContentLoaded', function() {
    FlashCardModule.init();
    console.log('üé¥ ÊöóË®ò„Ç´„Éº„Éâ„É¢„Ç∏„É•„Éº„É´ÂàùÊúüÂåñÂÆå‰∫Ü');
});
